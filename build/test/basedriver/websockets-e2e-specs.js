"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
require("source-map-support/register");
var _lodash = _interopRequireDefault(require("lodash"));
var _2 = require("../..");
var _fakeDriver = require("../protocol/fake-driver");
var _chai = _interopRequireDefault(require("chai"));
var _chaiAsPromised = _interopRequireDefault(require("chai-as-promised"));
var _ws = _interopRequireDefault(require("ws"));
var _bluebird = _interopRequireDefault(require("bluebird"));
_chai.default.use(_chaiAsPromised.default);
describe('Websockets (e2e)', function () {
  let baseServer;
  let driver;
  const SESSION_ID = 'foo';
  const WS_DATA = 'Hello';
  const PORT = 8181;
  before(async function () {
    driver = new _fakeDriver.FakeDriver();
    driver.sessionId = SESSION_ID;
    baseServer = await (0, _2.server)({
      routeConfiguringFunction: (0, _2.routeConfiguringFunction)(driver),
      port: PORT
    });
  });
  after(async function () {
    await baseServer.close();
  });
  describe('web sockets support', function () {
    it('should be able to add websocket handler and remove it', async function () {
      const wss = new _ws.default.Server({
        noServer: true
      });
      wss.on('connection', ws => {
        if (ws && ws.readyState === _ws.default.OPEN) {
          ws.send(WS_DATA);
        }
      });
      const previousListenerCount = baseServer.listenerCount('upgrade');
      const endpoint = `${_2.DEFAULT_WS_PATHNAME_PREFIX}/hello`;
      const timeout = 5000;
      await baseServer.addWebSocketHandler(endpoint, wss);
      baseServer.listenerCount('upgrade').should.be.above(previousListenerCount);
      _lodash.default.keys(await baseServer.getWebSocketHandlers()).length.should.eql(1);
      await new _bluebird.default((resolve, reject) => {
        const client = new _ws.default(`ws://localhost:${PORT}${endpoint}`);
        client.on('connection', (ws, req) => {
          ws.should.not.be.empty;
          req.connection.remoteAddress.should.not.be.empty;
        });
        client.on('message', data => {
          data.toString().should.eql(WS_DATA);
          resolve();
        });
        client.on('error', reject);
        setTimeout(() => reject(new Error('No websocket messages have been received after the timeout')), timeout);
      });
      (await baseServer.removeWebSocketHandler(endpoint)).should.be.true;
      _lodash.default.keys(await baseServer.getWebSocketHandlers()).length.should.eql(0);
      await new _bluebird.default((resolve, reject) => {
        const client = new _ws.default(`ws://localhost:${PORT}${endpoint}`);
        client.on('message', data => reject(new Error(`No websocket messages are expected after the handler ` + `has been removed. '${data === null || data === void 0 ? void 0 : data.toString()}' is received instead. `)));
        client.on('error', resolve);
        setTimeout(resolve, timeout);
      });
      baseServer.listenerCount('upgrade').should.be.above(previousListenerCount);
    });
  });
});require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC9iYXNlZHJpdmVyL3dlYnNvY2tldHMtZTJlLXNwZWNzLmpzIiwibmFtZXMiOlsiX2xvZGFzaCIsIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiXzIiLCJfZmFrZURyaXZlciIsIl9jaGFpIiwiX2NoYWlBc1Byb21pc2VkIiwiX3dzIiwiX2JsdWViaXJkIiwiY2hhaSIsInVzZSIsImNoYWlBc1Byb21pc2VkIiwiZGVzY3JpYmUiLCJiYXNlU2VydmVyIiwiZHJpdmVyIiwiU0VTU0lPTl9JRCIsIldTX0RBVEEiLCJQT1JUIiwiYmVmb3JlIiwiRmFrZURyaXZlciIsInNlc3Npb25JZCIsInNlcnZlciIsInJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbiIsInBvcnQiLCJhZnRlciIsImNsb3NlIiwiaXQiLCJ3c3MiLCJXZWJTb2NrZXQiLCJTZXJ2ZXIiLCJub1NlcnZlciIsIm9uIiwid3MiLCJyZWFkeVN0YXRlIiwiT1BFTiIsInNlbmQiLCJwcmV2aW91c0xpc3RlbmVyQ291bnQiLCJsaXN0ZW5lckNvdW50IiwiZW5kcG9pbnQiLCJERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWCIsInRpbWVvdXQiLCJhZGRXZWJTb2NrZXRIYW5kbGVyIiwic2hvdWxkIiwiYmUiLCJhYm92ZSIsIl8iLCJrZXlzIiwiZ2V0V2ViU29ja2V0SGFuZGxlcnMiLCJsZW5ndGgiLCJlcWwiLCJCIiwicmVzb2x2ZSIsInJlamVjdCIsImNsaWVudCIsInJlcSIsIm5vdCIsImVtcHR5IiwiY29ubmVjdGlvbiIsInJlbW90ZUFkZHJlc3MiLCJkYXRhIiwidG9TdHJpbmciLCJzZXRUaW1lb3V0IiwiRXJyb3IiLCJyZW1vdmVXZWJTb2NrZXRIYW5kbGVyIiwidHJ1ZSJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4iLCJzb3VyY2VzIjpbInRlc3QvYmFzZWRyaXZlci93ZWJzb2NrZXRzLWUyZS1zcGVjcy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgc2VydmVyLCByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24sXG4gICAgICAgICBERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWCB9IGZyb20gJy4uLy4uJztcbmltcG9ydCB7IEZha2VEcml2ZXIgfSBmcm9tICcuLi9wcm90b2NvbC9mYWtlLWRyaXZlcic7XG5pbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCBXZWJTb2NrZXQgZnJvbSAnd3MnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cbmRlc2NyaWJlKCdXZWJzb2NrZXRzIChlMmUpJywgZnVuY3Rpb24gKCkge1xuICBsZXQgYmFzZVNlcnZlcjtcbiAgbGV0IGRyaXZlcjtcbiAgY29uc3QgU0VTU0lPTl9JRCA9ICdmb28nO1xuICBjb25zdCBXU19EQVRBID0gJ0hlbGxvJztcbiAgY29uc3QgUE9SVCA9IDgxODE7XG5cbiAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBkcml2ZXIgPSBuZXcgRmFrZURyaXZlcigpO1xuICAgIGRyaXZlci5zZXNzaW9uSWQgPSBTRVNTSU9OX0lEO1xuICAgIGJhc2VTZXJ2ZXIgPSBhd2FpdCBzZXJ2ZXIoe1xuICAgICAgcm91dGVDb25maWd1cmluZ0Z1bmN0aW9uOiByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24oZHJpdmVyKSxcbiAgICAgIHBvcnQ6IFBPUlQsXG4gICAgfSk7XG4gIH0pO1xuICBhZnRlcihhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQgYmFzZVNlcnZlci5jbG9zZSgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnd2ViIHNvY2tldHMgc3VwcG9ydCcsIGZ1bmN0aW9uICgpIHtcbiAgICBpdCgnc2hvdWxkIGJlIGFibGUgdG8gYWRkIHdlYnNvY2tldCBoYW5kbGVyIGFuZCByZW1vdmUgaXQnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCB3c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7XG4gICAgICAgIG5vU2VydmVyOiB0cnVlLFxuICAgICAgfSk7XG4gICAgICB3c3Mub24oJ2Nvbm5lY3Rpb24nLCAod3MpID0+IHtcbiAgICAgICAgaWYgKHdzICYmIHdzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7XG4gICAgICAgICAgd3Muc2VuZChXU19EQVRBKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBjb25zdCBwcmV2aW91c0xpc3RlbmVyQ291bnQgPSBiYXNlU2VydmVyLmxpc3RlbmVyQ291bnQoJ3VwZ3JhZGUnKTtcbiAgICAgIGNvbnN0IGVuZHBvaW50ID0gYCR7REVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVh9L2hlbGxvYDtcbiAgICAgIGNvbnN0IHRpbWVvdXQgPSA1MDAwO1xuICAgICAgYXdhaXQgYmFzZVNlcnZlci5hZGRXZWJTb2NrZXRIYW5kbGVyKGVuZHBvaW50LCB3c3MpO1xuICAgICAgYmFzZVNlcnZlci5saXN0ZW5lckNvdW50KCd1cGdyYWRlJykuc2hvdWxkLmJlLmFib3ZlKHByZXZpb3VzTGlzdGVuZXJDb3VudCk7XG4gICAgICBfLmtleXMoYXdhaXQgYmFzZVNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycygpKS5sZW5ndGguc2hvdWxkLmVxbCgxKTtcbiAgICAgIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gbmV3IFdlYlNvY2tldChgd3M6Ly9sb2NhbGhvc3Q6JHtQT1JUfSR7ZW5kcG9pbnR9YCk7XG4gICAgICAgIGNsaWVudC5vbignY29ubmVjdGlvbicsICh3cywgcmVxKSA9PiB7XG4gICAgICAgICAgd3Muc2hvdWxkLm5vdC5iZS5lbXB0eTtcbiAgICAgICAgICByZXEuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzLnNob3VsZC5ub3QuYmUuZW1wdHk7XG4gICAgICAgIH0pO1xuICAgICAgICBjbGllbnQub24oJ21lc3NhZ2UnLCAoZGF0YSkgPT4ge1xuICAgICAgICAgIGRhdGEudG9TdHJpbmcoKS5zaG91bGQuZXFsKFdTX0RBVEEpO1xuICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGNsaWVudC5vbignZXJyb3InLCByZWplY3QpO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHJlamVjdChuZXcgRXJyb3IoJ05vIHdlYnNvY2tldCBtZXNzYWdlcyBoYXZlIGJlZW4gcmVjZWl2ZWQgYWZ0ZXIgdGhlIHRpbWVvdXQnKSksXG4gICAgICAgICAgdGltZW91dCk7XG4gICAgICB9KTtcblxuICAgICAgKGF3YWl0IGJhc2VTZXJ2ZXIucmVtb3ZlV2ViU29ja2V0SGFuZGxlcihlbmRwb2ludCkpLnNob3VsZC5iZS50cnVlO1xuICAgICAgXy5rZXlzKGF3YWl0IGJhc2VTZXJ2ZXIuZ2V0V2ViU29ja2V0SGFuZGxlcnMoKSkubGVuZ3RoLnNob3VsZC5lcWwoMCk7XG4gICAgICBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IGNsaWVudCA9IG5ldyBXZWJTb2NrZXQoYHdzOi8vbG9jYWxob3N0OiR7UE9SVH0ke2VuZHBvaW50fWApO1xuICAgICAgICBjbGllbnQub24oJ21lc3NhZ2UnLCAoZGF0YSkgPT5cbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKGBObyB3ZWJzb2NrZXQgbWVzc2FnZXMgYXJlIGV4cGVjdGVkIGFmdGVyIHRoZSBoYW5kbGVyIGAgK1xuICAgICAgICAgICAgYGhhcyBiZWVuIHJlbW92ZWQuICcke2RhdGE/LnRvU3RyaW5nKCl9JyBpcyByZWNlaXZlZCBpbnN0ZWFkLiBgKSlcbiAgICAgICAgKTtcbiAgICAgICAgY2xpZW50Lm9uKCdlcnJvcicsIHJlc29sdmUpO1xuICAgICAgICBzZXRUaW1lb3V0KHJlc29sdmUsIHRpbWVvdXQpO1xuICAgICAgfSk7XG4gICAgICBiYXNlU2VydmVyLmxpc3RlbmVyQ291bnQoJ3VwZ3JhZGUnKS5zaG91bGQuYmUuYWJvdmUocHJldmlvdXNMaXN0ZW5lckNvdW50KTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLElBQUFBLE9BQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLEVBQUEsR0FBQUQsT0FBQTtBQUVBLElBQUFFLFdBQUEsR0FBQUYsT0FBQTtBQUNBLElBQUFHLEtBQUEsR0FBQUosc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFJLGVBQUEsR0FBQUwsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFLLEdBQUEsR0FBQU4sc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFNLFNBQUEsR0FBQVAsc0JBQUEsQ0FBQUMsT0FBQTtBQUVBTyxhQUFJLENBQUNDLEdBQUcsQ0FBQ0MsdUJBQWMsQ0FBQztBQUV4QkMsUUFBUSxDQUFDLGtCQUFrQixFQUFFLFlBQVk7RUFDdkMsSUFBSUMsVUFBVTtFQUNkLElBQUlDLE1BQU07RUFDVixNQUFNQyxVQUFVLEdBQUcsS0FBSztFQUN4QixNQUFNQyxPQUFPLEdBQUcsT0FBTztFQUN2QixNQUFNQyxJQUFJLEdBQUcsSUFBSTtFQUVqQkMsTUFBTSxDQUFDLGtCQUFrQjtJQUN2QkosTUFBTSxHQUFHLElBQUlLLHNCQUFVLENBQUMsQ0FBQztJQUN6QkwsTUFBTSxDQUFDTSxTQUFTLEdBQUdMLFVBQVU7SUFDN0JGLFVBQVUsR0FBRyxNQUFNLElBQUFRLFNBQU0sRUFBQztNQUN4QkMsd0JBQXdCLEVBQUUsSUFBQUEsMkJBQXdCLEVBQUNSLE1BQU0sQ0FBQztNQUMxRFMsSUFBSSxFQUFFTjtJQUNSLENBQUMsQ0FBQztFQUNKLENBQUMsQ0FBQztFQUNGTyxLQUFLLENBQUMsa0JBQWtCO0lBQ3RCLE1BQU1YLFVBQVUsQ0FBQ1ksS0FBSyxDQUFDLENBQUM7RUFDMUIsQ0FBQyxDQUFDO0VBRUZiLFFBQVEsQ0FBQyxxQkFBcUIsRUFBRSxZQUFZO0lBQzFDYyxFQUFFLENBQUMsdURBQXVELEVBQUUs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
